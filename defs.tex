\catcode`\@=11

% TODO: pdftex wrapper that adds include path for defs.tex (so I don't have to
%  copy it eveywhere) and, on success, creates a file in the CWD with the
%  git commit hash of the version of defs.tex that was compatible

% TODO: insertion macros that use \@vskip macros
% TODO: lorem should not start new paragraph?
% TODO: general section macros with parametric fonts (plaintex beginsection
%   sucks): see engr240 memo
% TODO: more general figure macros (with caption support)?
% TODO: play arround with making slides with \special{papersize}/pdftex
% TODO: lipsum: option for long, medium, short paragraphs?
% TODO: \defsrc and \cite macros
% TODO: revise \@vskip: insert the @penalty + glue if the old penalty is larger
%   than new penalty?
% TODO: consider footline/headline during font changes
% TODO: don't set parskip and parindent
% TODO: automatic section/proclaim numbering (\count1.\count2.\count3)
% TODO: rework problem macros (again), and allow for prob statements to break
%   across pages with high penalty.
% TODO: macros for repeating entries/tabs in alignments (see ENGR240 work plan)
% TODO: fix \interject by using that primitve that tells you last paragraph width
% TODO: lists with ifmt of form (a), where the letter is placed in a box the
% maximum width of letters upto "l" (beyond that, "m" is too wide and the
% earlier ones look bad)
% TODO: pdftex transformations (scale, rotate, etc.)
% TODO: make item update icnt AFTER using it for current item, so that an
% update to icnt right before the item doesn't need to be one less
% TODO: update input guards to be very first in every file (catcode change
% before is broken)
% TODO: \adef for active define, like in OpTeX
% TODO: inline verb macro that works kinda like read file verb macro in that
% it makes the delimiter some characters we'll never use

\csname input:defs.tex\endcsname
\expandafter\let\csname input:defs.tex\endcsname=\endinput


%%% DEBUGGING/TESTING %%%

\def\supershowlists{\par
	{\showboxdepth=1000 \showboxbreadth=1000000 \showlists}}
\def\vruletest{\smash{\vrule height\vsize depth\vsize}}


%%% UTIL %%%

% Shortcut---long chains of expandafters can be a lot of characters.
\let\ea=\expandafter

\def\gobble#1{}
\def\gobbleto#1{\begingroup\def\@gobble##1#1{\endgroup}\@gobble}
% TODO: these are weird: remove them
\def\1#1#2{#1} % I.e., firstoftwo
\def\2#1#2{#2} % I.e., secondoftwo

\def\@END{\errmessage{this should not execute!}}
\def\@@END{\@END}

% General, low-level iteration macros.
% See \for, \forlet, and \fordef for example usage.
\newif\ifiterbreak
\let\iterbreak=\iterbreaktrue
\def\iterate{\iterbreakfalse \iterscan}
\def\iterproc{\iterbody \ifiterbreak
	\def\@iternext{\@iterrst \gobbleto\iterend}\else
	\let\@iternext=\iterscan \fi \@iternext}
\def\@iterrst{\let\iterbody=\@undefined \let\iterscan=\iterproc}
\@iterrst

\long\def\loop#1\repeat{\def\iterbody{#1\else \iterbreak \fi}\iterate\iterend}
\let\repeat=\fi

\newcount\@form
\newcount\@foria \newcount\@forib \newcount\@foric \newcount\@forid
\newcount\@forie \newcount\@forif \newcount\@forig \newcount\@forih
\def\@foriselect{\@foriset
	\@foria\@forib\@foric\@forid\@forie\@forif\@forig\@forih;;}
\def\@foriset#1#2;{\ifx#1;\errmessage{for loop nesting too deep}\else
	\let\@fori=#1\def\@foriselect{\@foriset#2;;}\ea\gobble\fi}
\def\@foru{\ifnum\@fori<\@form \@forbody\advance\@fori 1 \else \iterbreak \fi}
\def\@ford{\ifnum\@fori>\@form \@forbody\advance\@fori-1 \else \iterbreak \fi}
\long\def\for#1=#2..#3\do#4{{%
	\@foriselect \let#1=\@fori \@fori=#2\relax
	\futurelet\@foreq\@form#3\relax \def\@forbody{#4}%
	\ifnum\@fori<\@form \let\iterbody=\@foru \else \let\iterbody=\@ford \fi
	\iterate\iterend \if\@foreq=\@forbody\fi}}

\def\@forletib{\ifx\@next\@END \iterbreak \else \@forbody \fi}
\def\@forletis{\afterassignment\iterproc \let\@next=}
\long\def\forlet#1=#2\do#3{{%
	\def\@forbody{\let#1=\@next #3}%
	\let\iterbody=\@forletib \let\iterscan=\@forletis
	\iterate#2\@END\iterend}}

\def\@fordefib{\ifx\@next\@@END \iterbreak \else \@forbody \fi}
\def\@fordefis#1{\def\@next{#1}\iterproc}
\long\def\fordef#1=#2\do#3{{%
	\def\@forbody{\let#1=\@next #3}%
	\let\iterbody=\@fordefib \let\iterscan=\@fordefis
	\iterate#2\@END\iterend}}

% Zero pad a positive integer. E.g., \zeropad{000}{13} => 013.
% Idea from https://tex.stackexchange.com/a/412225/202281.
\def\zeropad#1#2{\ifnum1#1>1#2 \zeropad{#1}{0#2}\else#2\fi}

% Strip "pt" off the end of \the\dimenX. Argument must be fully expanded.
{\catcode`\p=12 \catcode`\t=12 \gdef\@#1pt{#1}}
\let\@strippt=\@ \let\@=\@undefined
\def\@dimnum#1{\ea\@strippt\the#1}

% Convert 4 digit hex number #2#3#4#5 to decimal in range [0,1) and store
% it in #1.
\newdimen\@htddimen
\def\@hextodec#1#2#3#4#5{%
	\@htddimen="#2#3#4#5sp \edef#1{\ea\@strippt\the\@htddimen}}

% Get the maximum/minimum width of the material produced by each macro
% argument among #2 and assign it to #1.
% E.g., \maxwd\dimen0={abc} assigns the max width of a,b,c to \dimen0.
\newdimen\@mwdtmp
\def\@mwd#1#2#3{\fordef\@=#3\do{\setbox\@box=\hbox{\@}%
	\ifdim\wd\@box#2\@mwdtmp \global\@mwdtmp=\wd\@box \fi}#1=\@mwdtmp}
\def\maxwd#1={\@mwdtmp=-\maxdimen \@mwd{#1}>}
\def\minwd#1={\@mwdtmp=\maxdimen \@mwd{#1}<}

% defer and edefer are for defering execution of the given tokens until after
% the current group. edefer is the same as defer, except edefer expands the
% given tokens first (in the same way edef does).
% Note: a defer can't contain more than 1 "child" defer.
% E.g., \defer{A\defer{B\defer{C}}} is ok, but not \defer{A\defer{B}\defer{C}}.
\newcount\defercnt \defercnt=0
\def\@defer#1#2{%
	\ea#1\csname$defer\the\defercnt\endcsname{#2}%
	\ea\aftergroup\csname$defer\the\defercnt\endcsname
	\advance\defercnt1 }
\def\defer{\@defer\gdef}
\def\edefer{\@defer\xdef}

% \savethe restores the current value of the given \the-expandable "variable"
% (e.g., a register) at the end of the current group. This allows one to
% modify a variable globally, yet still have it's value be restored.
\def\savethe#1{\ea\defer\ea{\ea#1\the#1}}

% \saveif is like \savethe, but for boolean variables defined via \newif.
\def\saveif#1{%
	\def\@saveiftrue{\defer{\let#1=\iftrue}}%
	\def\@saveiffalse{\defer{\let#1=\iffalse}}%
	#1\@saveiftrue\else\@saveiffalse\fi}

% \ascend causes the following local assignment to "ascend" up one level of
% grouping. E.g., \ascend\count0=3 changes \count0 to 3 locally and in the
% immediately surrounding group.
\def\ascend#1={\def\@ascend{\savethe{#1}}\afterassignment\@ascend#1=}


%%% PARAMETERS/REGISTER ALLOCATION %%%

% \parindent, \prob@sidesize, \iind, and \pc@sideskip should
% be kept in sync so that indentations look consistent.

\parindent=0pt
\parskip=\smallskipamount

\newskip\hugeskipamount \hugeskipamount=24pt plus8pt minus8pt
\newdimen\prob@sidesize \prob@sidesize=20pt
\newdimen\prob@rulegap  \prob@rulegap=5pt
\newskip\prob@topskip   \prob@topskip=16pt plus6pt minus6pt

% Registers for temporary use.
\newcount\@count   \newcount\@@count
\newskip\@skip     \newskip\@@skip
\newmuskip\@muskip \newmuskip\@@muskip
\newdimen\@dimen   \newdimen\@@dimen
\newbox\@box       \newbox\@@box


%%% FONTS %%%

% Most of the complexity in this font loading system is to make loading fonts
% at a given size easy. I.e., the system automatically picks the right font
% to scale, if necessary. A *font set* is a list of the same font at different
% design sizes in the form of a macro. E.g.,
%   \def\FSmyfs{myfs=\\17:myfont17;\\14:myfont14;;}
% (By convention, font set macros start with "FS".)
% Whenever we load a font from a font set, the font with the maximum design
% size that is no larger than the desired size is scaled appropriately.
% In the above example, "myfs" at 17pt will choose "myfont17 at17pt", while
% "myfs" at 16pt will choose "myfont14 at 16pt". As a special case, the
% smallest font will be chosen for sizes smaller than it.
% \FSnull is a special font set that means "always use \nullfont".
% 
% Fonts in fonts sets may have a non-default skewchar or hyphenchar by using
% \Fskew and \Fhyph. See FScm.tex for examples of how to use these macros.
% Fonts in font sets can also be scaled using \Fscale<numerator>/<denominator>.
% (Don't make <numerator> too big, or else you'll overflow TeX's max dimen!)
% 
% Math families are reassigned by redefining the 16 corresponding \FfamsetX
% macros. Text fonts are changed by letting \rmset, \bfset, etc. be equal to
% the desired font set. When adding new font styles (e.g., a bold slanted text
% font), it may also be necessary to redefine \Fupdfonts so that the associated
% style switch macros are updated appropriately. In any case, see FScm.tex for
% examples.

\let\newfam=\@undefined
\def\newfam{\errmessage{Don't use \noexpand\newfam with defs.tex!}}

\newdimen\Fsize \newdimen\Ftsize \newdimen\Fssize \newdimen\Fsssize
\newcount\@Fskewchar \newcount\@Fhyphenchar
\newcount\@Fscalenum \newcount\@Fscaleden

\def\FSnull{(null)=;;}
\def\Fskew{\global\@Fskewchar=}
\def\Fhyph{\global\@Fhyphenchar=}
\def\Fscale#1/{\global\@Fscalenum=#1\relax \global\@Fscaleden=}

\def\@Fbasename#1=#2;;{#1}
\def\@Fentries#1=#2;;{#2;}
\def\@Fgobble#1;{}
\def\@Fsearch#1:#2;{\gdef\@Fname{#2 }%
	\ifdim#1pt>\@dimen \else \let\\=\@Fgobble \fi}

% \@Fload loads a font with size \@dimen from font set #1 according to the
% rules described above.
\def\@Fload#1{\@Fskewchar=\defaultskewchar \@Fhyphenchar=\defaulthyphenchar
	\@Fscalenum=1 \@Fscaleden=1
	{\let\\=\@Fsearch\ea\@Fentries#1}%
	\@@dimen=\@dimen \multiply\@@dimen\@Fscalenum \divide\@@dimen\@Fscaleden
	\font\Ffont=\@Fname at\@@dimen
	\skewchar\Ffont=\@Fskewchar \hyphenchar\Ffont=\@Fhyphenchar}

% \Ffind finds a font with size \@dimen from font set #1. If it doesn't
% exist, load it. In either case, the resulting font is \Ffont.
\def\Ffind#1{\ifx#1\FSnull \let\Ffont=\nullfont \else
	\ea\let\ea\Ffont\csname\ea\@Fbasename#1\the\@dimen\endcsname
	\ifx\Ffont\relax
		\@Fload{#1}\ea\let\csname\ea\@Fbasename#1\the\@dimen\endcsname=\Ffont
	\fi\fi}

% \Fdef is a friendly wrapper of \Ffind. E.g., \Fdef\myfont\FScmr15pt loads
% cmr at 15pt into \myfont.
\def\Fdef#1#2{\def\@{\Ffind#2\let#1=\Ffont}\afterassignment\@\@dimen=}

\def\@Fdecompose#1#2#3{\let\@Ftset=#1\let\@Fsset=#2\let\@Fssset=#3}
\def\@Fupdfam"#1#2{%
	\ea\@Fdecompose#2%
	\@dimen=\Ftsize  \Ffind\@Ftset\textfont"#1=\Ffont
	\@dimen=\Fssize  \Ffind\@Fsset\scriptfont"#1=\Ffont
	\@dimen=\Fsssize \Ffind\@Fssset\scriptscriptfont"#1=\Ffont}
\def\Fupdfams{%
	\@Fupdfam"0\Ffamseta \@Fupdfam"1\Ffamsetb
	\@Fupdfam"2\Ffamsetc \@Fupdfam"3\Ffamsetd
	\@Fupdfam"4\Ffamsete \@Fupdfam"5\Ffamsetf
	\@Fupdfam"6\Ffamsetg \@Fupdfam"7\Ffamseth
	\@Fupdfam"8\Ffamseti \@Fupdfam"9\Ffamsetj
	\@Fupdfam"A\FfamsetA \@Fupdfam"B\FfamsetB
	\@Fupdfam"C\FfamsetC \@Fupdfam"D\FfamsetD
	\@Fupdfam"E\FfamsetE \@Fupdfam"F\FfamsetF}
\def\Fupdfonts{\@dimen=\Fsize
	\Ffind\rmset \let\rmfont=\Ffont
	\Ffind\miset \let\mifont=\Ffont
	\Ffind\itset \let\itfont=\Ffont
	\Ffind\slset \let\slfont=\Ffont
	\Ffind\bfset \let\bffont=\Ffont
	\Ffind\ttset \let\ttfont=\Ffont
	\Ffind\scset \let\scfont=\Ffont
	\Ffind\ssset \let\ssfont=\Ffont}

% \Fmch and \Fch are for chaning font sizes. Note that these only change font
% sizes, the \normalbaselineskip, and the \strutbox. To make the change look
% good, other document changes are probably necessary (e.g., the display
% skips).
\def\@Fmch{\Fupdfams \Fupdfonts
	\setbox\strutbox=\hbox{%
		\vrule height.7\normalbaselineskip depth.3\normalbaselineskip width0pt}
	\normalbaselines\rm}
\def\Fmch#1/#2/#3/#4/{%
	\Fsize=#1\relax \Ftsize=#2\relax \Fssize=#3\relax \Fsssize=#4\relax
	\afterassignment\@Fmch \normalbaselineskip=}
\def\Fch#1/{\Fsize=#1\relax
	\afterassignment\@Fmch \normalbaselineskip=}

\def\elevenpt{\Fmch11pt/11pt/8pt/5pt/13pt
	% These are the default values from plain TeX.
	\abovedisplayskip=12pt plus3pt minus9pt
	\belowdisplayskip=12pt plus3pt minus9pt
	\abovedisplayshortskip=0pt plus3pt
	\belowdisplayshortskip=7pt plus3pt minus4pt}
\def\tenpt{\Fmch10pt/10pt/7pt/5pt/12pt
	% These are the default values from plain TeX.
	\abovedisplayskip=12pt plus3pt minus9pt
	\belowdisplayskip=12pt plus3pt minus9pt
	\abovedisplayshortskip=0pt plus3pt
	\belowdisplayshortskip=7pt plus3pt minus4pt}
\def\ninept{\Fmch9pt/9pt/6pt/5pt/11pt
	\abovedisplayskip=10pt plus3pt minus7pt
	\belowdisplayskip=10pt plus3pt minus7pt
	\abovedisplayshortskip=0pt plus3pt
	\belowdisplayshortskip=6pt plus3pt minus3pt}

\input FScm
\tenpt

\Fdef\bigbf\FScmbx14.4pt
\Fdef\twelvebf\FScmbx12pt
\Fdef\tenbf\FScmbx10pt


%%% VERTICAL SKIPS %%%

\def\hugeskip{\vskip\hugeskipamount}
\def\hugebreak{\par \ifdim\lastskip<\hugeskipamount
	\removelastskip \penalty-400 \hugeskip \fi}

% \revskip replaces the previous glue on the vertical list with the
% specified glue.
\def\revskip{\par\removelastskip\vskip}
\def\resmallskip{\revskip\smallskipamount}
\def\remedskip{\revskip\medskipamount}
\def\rebigskip{\revskip\bigskipamount}
\def\rehugeskip{\revskip\hugeskipamount}

% \@vskip inserts the specified glue only if \lastskip=0pt (i.e., if the last
% item on the current vertical list isn't a glue). The intented use is for
% macros that typically insert glue before some content (e.g., a figure or an
% algorithm), so that the user can override the glue before the content simply
% by specifying an explicit skip before using the macro. Also, the penalty in
% register \@penalty is inserted before the glue if \@penalty isn't 0,
% and \@penalty is zeroed.
\newcount\@penalty \@penalty=0
\def\@vskip{%
	\par\begingroup
	\def\@{\ifdim\lastskip=0pt
		\ifnum\@penalty=0 \else \penalty\@penalty \fi
		\vskip\@skip \fi \global\@penalty=0 \endgroup}%
	\afterassignment\@\@skip=}
\def\@smallskip{\@vskip\smallskipamount}
\def\@medskip{\@vskip\medskipamount}
\def\@bigskip{\@vskip\bigskipamount}
\def\@hugeskip{\@vskip\hugeskipamount}
\def\@smallbreak{\@penalty-50 \@smallskip}
\def\@medbreak{\@penalty-100 \@medskip}
\def\@bigbreak{\@penalty-200 \@bigskip}
\def\@hugebreak{\@penalty-400 \@hugeskip}

% Change parskip until after the next paragraph.
\newskip\tps@oldparskip
\def\tmpparskip{%
	\ifx\tps@oldpar\@undefined
		\global\let\tps@oldpar=\par
		\global\tps@oldparskip=\parskip
		\gdef\tps@restore{%
			\global\parskip=\tps@oldparskip
			\global\let\par=\tps@oldpar
			\global\let\tps@oldpar=\@undefined}
		\gdef\par{\ifhmode \tps@restore\par \fi}%
	\fi
	\global\parskip=}
\let\tps@restore=\relax
\def\noparskip{\tmpparskip0pt }
\def\yesparskip{\@restoreparskip}


%%% TEXT %%%

% Lists. Indent by iind*ilvl + ioff, where ilvl is incremented per nest level.
% Derive bullet from ifmt based on icnt, which is incremented per item.
\newcount\icnt
\newcount\ilvl \ilvl=0
\newdimen\iind \iind=20pt
\newdimen\ioff \ioff=0pt
\let\ifmt=\@undefined
\def\@blist{$\bullet$\enspace}
\def\@nlist{{\rm\the\icnt.}\enspace}
\def\@clist{{\rm\char\icnt.}\enspace}
\def\blist{\let\ifmt=\@blist \icnt=0  \list}
\def\nlist{\let\ifmt=\@nlist \icnt=0  \list}
\def\ulist{\let\ifmt=\@clist \icnt=64 \list}
\def\llist{\let\ifmt=\@clist \icnt=96 \list}
\def\list{\advance\ilvl1 \aftergroup\par}
\def\item{\advance\icnt1 \@item \noindent\llap{\ifmt}}
\def\cont{\@item \noindent}
\def\@item{\par \global\hangafter=0
	\global\hangindent=\iind \global\multiply\hangindent\ilvl
	\global\advance\hangindent\ioff}
\let\itemitem=\@undefined% Undefine macro from plain tex.

% Like Plain TeX narrower, but advance left/rightskip by specified ammount
% instead of by parindent.
\def\@narrowerby{\advance\leftskip\@dimen \advance\rightskip\@dimen}
\def\narrowerby{\afterassignment\@narrowerby \@dimen=}

% Spread tokens in #1 by glue in #2.
% E.g., "abcd" => "a  b  c  d".
\def\spread#1#2{%
	\def\@terminator##1\@help{}%
	\def\@help##1{##1\hskip#2\relax\@help}%
	\@help#1\@terminator\unskip}

{\catcode`\?=13
\let\+=\@undefined% Plain TeX makes this an \outer def.
\gdef\digalign{%
	\catcode`\?=13 \def?{{\setbox0=\hbox{0}\kern\wd0}}%
	\def\+{{\setbox0=\hbox{$\m@th-$}\kern\wd0}}%
	\def\.{{\setbox0=\hbox{$\m@th.$}\kern\wd0}}}
}

% Plain TeX only provides llap and rlap.
\def\clap#1{\hbox to0pt{\hss#1\hss}}

% Surround content, which should be a box, with rules.
\def\vboxit#1{\vbox{\hrule\hbox{\vrule#1\vrule}\hrule}}

% Same as plain raggedright, but 2em changed to 3em, and it advances rightskip,
% instead of setting it.
\def\raggedright{%
	\advance \rightskip by 0pt plus 3em
	\spaceskip=0.3333em \xspaceskip=0.5em\relax}

% Theorems+proof, lemmas+proof, definitions, etc.
% Plain TeX proclaim has been modified to use \@penalty \@vskip constructions
% and suppress parskip.
\def\proclaim #1. #2\par{%
	\par \@medbreak \noparskip
	\noindent{\bf#1.\enspace}{\sl#2\par}%
	\@penalty55 \@medskip \noparskip}
\def\proof{% use \proof ... \qed
	\par \@medskip \noparskip
	\begingroup \let\@qed=\qed \def\qed{\@qed\@medskip\noparskip\endgroup}%
	\noindent{\it Proof.\enspace}}
\def\qedbox{\rect{0.6em}{0.6em}{0.5pt}}
\def\qed{\unskip\hskip1em plus1fil \hbox{}\nobreak\hfill$\qedbox$\par}

\def\topic#1. {\par{\bf#1.}\enspace}

\newbox\@pagebox
\def\page{\supereject \begingroup
	\setbox\@pagebox=\vbox to\vsize\bgroup \boxmaxdepth=\maxdepth}
\def\endpage{\egroup% End vbox started in \page.
	\def\pagebody{\unvbox255 \box\@pagebox}\hbox{}\eject\endgroup}


%%% MATH %%%

% Shortcuts
\let\dsty=\displaystyle
\let\tsty=\textstyle
\let\ssty=\scriptstyle
\let\sssty=\scriptscriptstyle
\let\lc=\lceil
\let\rc=\rceil
\let\lf=\lfloor
\let\rf=\rfloor

% Alternate names
\let\:=\colon % Punctuation colon. Regular colon is a relation.
\let\lxor=\oplus
\let\limp=\rightarrow
\let\liff=\leftrightarrow
\let\grad=\nabla
\let\del=\partial
\let\<=\langle
\let\>=\rangle% Note this overrides \> = medmuskip.

% \left and \right but the resulting atoms are open/close, not inner.
\def\ml{\mathopen{}\mathclose\bgroup\left}
\def\mr{\aftergroup\egroup\right}

% https://www.tug.org/TUGboat/tb22-4/tb72perlS.pdf
\def\mllap{\mathpalette\@mllap}
\def\mrlap{\mathpalette\@mrlap}
\def\mclap{\mathpalette\@mclap}
\def\@mllap#1#2{\llap{$\m@th#1{#2}$}}
\def\@mrlap#1#2{\rlap{$\m@th#1{#2}$}}
\def\@mclap#1#2{\clap{$\m@th#1{#2}$}}

% Integrals
\def\d{{\rm d}} % Preceed with \, usually.
\def\dx{\d x} \def\dy{\d y} \def\dt{\d t}
\def\@intkern{\mkern-9mu\mathchoice{\mkern-5mu}{}{}{}}
\def\iint{\int\@intkern\int\nolimits}
\def\iiint{\int\@intkern\int\@intkern\int\nolimits}

\def\bmatrix#1{\left[\matrix{#1}\right]}

% Upgraded \eqalign that works for multiple aligned columns.
% Redefine \eqalignskip to change column spacing.
\def\@malign{\hfil\strut$\dsty{##}$\tabskip=0pt&$\dsty{{}##}$\hfil}
\def\eqalignskip{\qquad}
\def\eqalign#1{\null\,\vcenter{\openup1\jot \m@th
	\ialign{\span\@malign&&\eqalignskip\span\@malign\crcr #1\crcr}}\,}

% eqalignno, but you can add an explaination to each line.
\def\exalignno#1{\displ@y \tabskip=\centering
	\halign to\displaywidth{%
		\hfil$\@lign\dsty{##}$\tabskip=0pt&$\@lign\dsty{{}##}$\hfil&
		\qquad\hbox{\rm##}\hfil\tabskip=\centering&
		\llap{$\@lign##$}\tabskip=0pt\crcr #1\crcr}}

% Add a paragraph (or arbitrary vertical material) into the middle of an
% eqalignno/exalignno. Works best if \hsize == \displaywidth.
% This always surrounds the interjecting text with belowdisplayskip and
% abovedisplayskip, respectively, which might look bad in situations where
% TeX would have chosen the short variants of those skips. In such cases,
% manual adjustments may be required.
\def\interject#1{\noalign{\vskip\belowdisplayskip\vbox{%
	\hsize=\displaywidth \normalbaselines #1}\vskip\abovedisplayskip}}

% For \sums mainly. This just sticks .25ex between lines,
% which seems to work well enough.
\def\substack#1{\vtop{%
	\baselineskip=-1000pt \lineskip=.25ex \lineskiplimit=\maxdimen
	\ialign{\hfil$\ssty##$\hfil\crcr#1\crcr}}}

% \overline{#3}, except #1mu shorter on left and #2mu shorter on right.
\def\varbar#1#2#3{{\@muskip=#1mu \@@muskip=#2mu \mkern\@muskip
	\overline{\mkern-\@muskip{#3}\mkern-\@@muskip}\mkern\@@muskip}{}}

% Missing from plain tex.
\def\imp{\;\Longrightarrow\;}% To match \iff.
\def\lcm{\mathop{\rm lcm}}% To match \gcd.

\def\mop#1(#2){\mathop{\rm{#1}}\ml({#2}\mr)}
\def\GF{\mathop{\rm GF}}
\def\Span{\mathop{\rm span}}
\def\sgn{\mathop{\rm sgn}}
\mathchardef\nmid="3A2D
\def\rank{\mathop{\rm rank}}
\def\mod#1{\ ({\rm mod}\,\,#1)}% \pmod not good for in-line math.
\def\notprec{\mathrel{\mathpalette\c@ncel\prec}}
\def\notpreceq{\mathrel{\mathpalette\c@ncel\preceq}}

% Sets
\def\N{{\bb N}}
\def\Z{{\bb Z}}
\def\Q{{\bb Q}}
\def\R{{\bb R}}
\def\C{{\bb C}}
\def\powset{{\sr P}}

% Big O and friends
% bigomega and bigtheta are upright, so bigo should be too, hence eucal
% (but not just a roman O, since it looks too much like zero).
% \Omega and \Theta are class 7, so make sure they get typeset in \rm.
% \omega is class 0, so no worries there.
\def\bigo{{\es O}}
\def\littleo{{\mi o}}
\def\bigomega{{\rm \Omega}}
\def\littleomega{\omega}
\def\bigtheta{{\rm \Theta}}

% i/j/k vector components.
\def\ihat{{\bf\mathaccent"705E \mathchar"7010}}
\def\jhat{{\bf\mathaccent"705E \mathchar"7011}}
\def\khat{{\bf\mathaccent"705E k}}

\def\?{\buildrel?\over=}
\def\falling#1#2{#1^{\underline{#2}}}
\def\rising#1#2{#1^{\overline{#2}}}
\def\rect#1#2#3{% inner width, inner height, line thickness 
	\vcenter{\vbox{%
		\hrule height#3%
		\hbox{\vrule width#3height#2\kern#1\vrule width#3}%
		\hrule height#3}}}

\def\@permend\,\@permiter{}
\def\@permiter#1,{#1\,\@permiter}
\def\perm(#1){(\@permiter#1\@permend,)}

% TODO weird
\def\mvstrut#1{\vcenter{\hrule width0pt height#1}}
\def\mhstrut#1{\vcenter{\hrule width#1 height0pt}}

% TODO this is weird; get rid of it.
% mappalette is like mathpalette, except instead of the first argument to the
% given CS being the current math style, it is whatever the given mapfour maps
% the current math style to.
\def\mapfour#1#2#3#4#5{\ifcase #5 #1\or #2\or #3\or #4\fi}
\def\mappalette#1#2#3{\mathchoice
	{\edef\@arg{#10}\ea#2\ea{\@arg}{#3}}{\edef\@arg{#11}\ea#2\ea{\@arg}{#3}}
	{\edef\@arg{#12}\ea#2\ea{\@arg}{#3}}{\edef\@arg{#13}\ea#2\ea{\@arg}{#3}}}

% TODO: remove/replace with ooalign
% Superimposition
% This was mostly an excercise. This would probably
% be better done with alignment macros like ooalign.
\def\supimp#1#2{{%
	\leavevmode
	\setbox1=\hbox{#1}\setbox2=\hbox{#2}%
	\ifdim\wd1<\wd2
		\setbox0=\box1 \setbox1=\box2 \setbox2=\box0
	\fi
	\hbox to \wd1{\hfil\unhbox2\hfil}\llap{\unhbox1}}}
\def\@msupimpinternal#1#2{%
	\supimp{$\mathsurround=0pt \1#1\1#2$}{$\mathsurround=0pt \2#1\2#2$}}
\def\msupimpmap#1#2#3{\mappalette{#1}\@msupimpinternal{{#2}{#3}}}
\def\msupimp{\msupimpmap
	{\mapfour{\dsty\dsty}{\tsty\tsty}{\ssty\ssty}{\sssty\sssty}}}

% Boxed computer-sciency arrays and matrices
% Example usage (in math mode):
%   \narray\\{17}\\{39}\\{14} \;\cdots\; \array\arri{n}\\{7}
\newcount\arrcnt \arrcnt=0
\newdimen\arrlen \arrlen=20pt
\newif\ifdonecell
\def\@mcell#1#2#3{\vcenter{\vboxit{\hbox to#1{%
	\hss$\m@th\mvstrut{#2}\smash{\vcenter{\hbox{$\m@th#3$}}}$\hss}}}}
\def\narray{\let\@arrconv=\the  \arrcnt=0  \array}% 0, 1, 2, ...
\def\uarray{\let\@arrconv=\char \arrcnt=65 \array}% A, B, C, ...
\def\larray{\let\@arrconv=\char \arrcnt=97 \array}% a, b, c, ...
\def\earray{\let\@arrconv=\relax \arrcnt=0 \array}% No labels
\def\arri#1{\def\@arrconv##1{#1}}
\def\array{\donecellfalse \let\\=\arraycell}
\def\@arrmcell{\@mcell\arrlen\arrlen}
\let\@arrconv=\relax
\def\arraycell#1{%
	\ifdonecell \kern-0.4pt \else \donecelltrue \fi
	\mathord{\mathop{\@arrmcell{#1}}\limits
		\ifx\@arrconv\relax \else ^{\@arrconv\arrcnt} \fi}
	\advance \arrcnt by1 }
\def\boxmat#1{\vbox{%
	\offinterlineskip
	\everycr{\noalign{\kern-0.4pt}}%
	\tabskip=0pt
	\kern0.4pt
	\halign{$\m@th\@arrmcell{##}$&&\kern-0.4pt$\m@th\@arrmcell{##}$\crcr
		#1\crcr}%
	\kern0.4pt}}


%%% PROBLEMS %%%
% TODO allow breaking problem statements across pages.

% p@last is last problem-related macro used.
%   0 => other
%   1 => header
%   2 => statement
\newcount\p@last \p@last=0
\newbox\pstmt@box
\def\prob{\@phdr\twelvebf}
\def\part{\@phdr\tenbf}
\def\@phdr#1.{%
	\ifnum\p@last=2 \@endpstmt \else \par \fi
	\ifnum\p@last=0
		\vskip 0pt plus.3\vsize \penalty0 \vskip 0pt plus-.3\vsize
	\fi
	\ifnum\p@last<2 \nobreak\vskip\prob@topskip \fi
	\nointerlineskip\hbox{#1}%
	\p@last=1 }
\def\pstmt{%
	\par
	\p@last=2
	\nobreak\medskip
	\setbox\pstmt@box=\vbox\bgroup
		\advance \hsize by -2\prob@sidesize
		\def\nostrut{\let\strut=\relax}%
		\ninept\sl\noindent\strut}
\def\@endpstmt{%
	\ifhmode\unskip\fi\strut\egroup% End the vbox started in \pstmt.
	\dimen0=\ht\pstmt@box \advance \dimen0 by 2pt
	\dimen1=\dp\pstmt@box \advance \dimen1 by 2pt
	\nointerlineskip\hbox to \hsize{%
		\hfil
		\vrule height\dimen0 depth\dimen1
		\hskip\prob@rulegap
		\box\pstmt@box
		\hskip\prob@rulegap
		\hskip 0.4pt plus1fil}%
	\nointerlineskip
	\penalty25\medskip}
\def\psoln{%
	\ifcase\p@last
		\errmessage{psoln must be preceded by prob/part/pstmt}%
	\or
		\nobreak\medskip
	\or
		\@endpstmt
	\fi
	\p@last=0
	\noparskip}


%%% VERBATIM %%%

% Usage:
%   \Verb[local init]<<an arbitrary delimiter
%   {this} %is
%		$all$ ~verbatim--
%   an arbitrary delimiter
%   Back to non-verbatim.
\newtoks\Vbol \Vbol={}
\newtoks\Vibl \Vibl={\leavevmode\endgraf}
\newtoks\Vend \Vend={}
\def\@Vterm{\errmessage{Verb delimiter should be on new line}}
\def\@Vproc{%
	\ifx\@Vnext\@Vterm% End of verbatim?
		\let\@Vterm=\relax% Silence error message.
		\the\Vend
	\else \@Vibl\def\@Vibl{\the\Vibl}\the\Vbol \fi}
{\obeylines\gdef\Verb#1<<{\begingroup%
	\def\@Verb##1^^M{% Scan delimiter like Unix here doc.
		\long\def\@@Verb####1##1{%
			\futurelet\@Vnext\@Vproc####1\@Vterm\endgroup}%
		\@@Verb}%
	\let\@Vibl=\relax%
	\def\do##1{\catcode`##1=12 }\dospecials% Init specials
	\def\par{\futurelet\@Vnext\@Vproc}%
	\obeylines% Init lines
	\@Vobeyspaces% Init spaces
	#1% User post-init
	\@Verb}}

% Like Plain TeX \obeyspaces, but use control spaces, not \space.
{\obeyspaces\gdef\@Vobeyspaces{\let =\ \obeyspaces}}

% Convert tabs into 4 spaces (for code listings).
{\catcode`\^^I=13
\gdef\expandtabs{\catcode`\^^I=13\def^^I{\ \ \ \ }}}

% Start code block. Terminate with "EOF" (hence, this is not suitable for code
% that literally contains "EOF").
\def\Vcodeinit{
	\narrowerby20pt \parskip=0pt \expandtabs \tt \Vbol={}%
	\Vibl={\leavevmode\endgraf\penalty1000}\Vend={\leavevmode\endgraf}}
\def\Vcode{\par \@medbreak
	\Verb \aftergroup\@medskip \aftergroup\noparskip \Vcodeinit<<EOF}

% Read file with file name #2 verbatim with pre init #1.
% The delimiter ^^fc^^fd^^fe^^ff should never appear
% (those 4 bytes are invalid UTF8).
{\obeylines\gdef\Vinput#1#2{\Verb#1<<^^fc^^fd^^fe^^ff
	\input#2
	^^fc^^fd^^fe^^ff}}


%%% PDFTeX %%%

\ifx\pdfoutput\@undefined \else

% Insert pdf image.
\def\pdfimg#1file #2.pdf{\pdfximage#1{#2.pdf}\pdfrefximage\pdflastximage}

% Color support.
\mathchardef\@colorstackn=\pdfcolorstackinit page {0 g 0 G}
\def\@pdfcolorstackpush#1{\pdfcolorstack\@colorstackn push {#1}}
\def\@pdfcolorstackpop{\pdfcolorstack\@colorstackn pop}
\def\@setcolor#1{\@pdfcolorstackpush{#1}\aftergroup\@pdfcolorstackpop}
\def\setcolorrgb#1#2#3{\@setcolor{#1 #2 #3 rg #1 #2 #3 RG}}
\def\setcolorgrey#1{\@setcolor{#1 g #1 G}}

% Basic colors.
\def\cblack{\setcolorgrey{0}}
\def\cwhite{\setcolorgrey{1}}
\def\cred{\setcolorrgb    {1}{0}{0}}
\def\cgreen{\setcolorrgb  {0}{1}{0}}
\def\cblue{\setcolorrgb   {0}{0}{1}}
\def\ccyan{\setcolorrgb   {0}{1}{1}}
\def\cmagenta{\setcolorrgb{1}{0}{1}}
\def\cyellow{\setcolorrgb {1}{1}{0}}

% Arbitrary HTML-style hex colors.
\def\chex"#1#2#3#4#5#6{%
	\begingroup
	\@hextodec\R#1#2#1#2%
	\@hextodec\G#3#4#3#4%
	\@hextodec\B#5#6#5#6%
	\edef\@{\endgroup\noexpand\setcolorrgb{\R}{\G}{\B}}%
	\@\ignorespaces}

% 16 shades of grey.
\def\cgrey"#1{%
	\begingroup
	\@hextodec\grey#1#1#1#1%
	\edef\@{\endgroup\noexpand\setcolorgrey{\grey}}%
	\@\ignorespaces}

\fi % PDFTeX

\catcode`\@=12
\endinput
